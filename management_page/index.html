<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Management - Competence CRM</title>
<link rel="stylesheet" href="/assets/sidebar.css">
<link rel="stylesheet" href="/assets/styles.css">
<style>
.content{margin-left:280px;padding:24px;width:calc(100% - 280px);min-height:100vh}
.header{background:#fff;padding:20px 24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
.header h2{font-size:26px;color:#1e293b;font-weight:700;margin:0}
.tabs{display:flex;gap:8px;margin-bottom:24px;background:#fff;padding:8px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.tab{padding:12px 24px;border:none;background:transparent;color:#64748b;font-size:14px;font-weight:600;cursor:pointer;border-radius:8px;transition:all .2s}
.tab.active{background:#6366f1;color:#fff}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:20px}
.card-header{padding:20px 24px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}
.card-header h5{font-size:18px;color:#1e293b;margin:0;font-weight:700}
.card-body{padding:24px}
table{width:100%;border-collapse:collapse;font-size:14px}
thead{background:#f8fafc}
th{padding:14px 16px;text-align:left;font-weight:700;color:#475569;font-size:12px;text-transform:uppercase}
td{padding:14px 16px;border-bottom:1px solid #f1f5f9;color:#334155}
tbody tr:hover{background:#f8fafc}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:#6366f1;color:#fff}
.btn-success{background:#10b981;color:#fff}
.btn-danger{background:#ef4444;color:#fff}
.btn-sm{padding:7px 14px;font-size:13px}
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center}
.loading.show{display:flex}
.spinner{border:4px solid rgba(255,255,255,.2);border-top:4px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.content{margin-left:0;width:100%;padding:16px}}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div></div>
<div id="sidebarContainer"></div>

<main class="content">
<div class="header">
<h2>Team Management</h2>
<div style="display:flex;gap:12px">
<button class="btn btn-success" onclick="showAddEmployee()">Add Employee</button>
<button class="btn btn-primary" onclick="showAddClient()">Add Client</button>
</div>
</div>

<div id="addEmployeeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center">
<div style="background:#fff;border-radius:12px;padding:32px;width:90%;max-width:500px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1)">
<h3 style="margin:0 0 24px;font-size:20px;color:#1e293b">Add New Employee</h3>
<div style="margin-bottom:16px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Name *</label>
<input id="empName" type="text" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px" required>
</div>
<div style="margin-bottom:16px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Email *</label>
<input id="empEmail" type="email" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px" required>
</div>
<div style="margin-bottom:24px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Password *</label>
<input id="empPassword" type="password" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px" required>
</div>
<div style="display:flex;gap:12px;justify-content:flex-end">
<button class="btn" style="background:#64748b;color:#fff" onclick="hideAddEmployee()">Cancel</button>
<button class="btn btn-success" onclick="submitEmployee()">Add Employee</button>
</div>
</div>
</div>

<div id="addClientModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center">
<div style="background:#fff;border-radius:12px;padding:32px;width:90%;max-width:500px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1)">
<h3 style="margin:0 0 24px;font-size:20px;color:#1e293b">Add New Client</h3>
<div style="margin-bottom:16px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Client Name *</label>
<input id="clientName" type="text" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px" required>
</div>
<div style="margin-bottom:16px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Company</label>
<input id="clientCompany" type="text" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">
</div>
<div style="margin-bottom:16px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Email</label>
<input id="clientEmail" type="email" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">
</div>
<div style="margin-bottom:24px">
<label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px">Phone</label>
<input id="clientPhone" type="tel" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">
</div>
<div style="display:flex;gap:12px;justify-content:flex-end">
<button class="btn" style="background:#64748b;color:#fff" onclick="hideAddClient()">Cancel</button>
<button class="btn btn-primary" onclick="submitClient()">Add Client</button>
</div>
</div>
</div>

<div class="tabs">
<button class="tab active" onclick="switchTab('employees')">Employees</button>
<button class="tab" onclick="switchTab('clients')">Clients</button>
</div>

<div class="card" id="employeesTab">
<div class="card-header">
<h5>Team Members</h5>
<button class="btn btn-sm btn-primary" onclick="loadEmployees()">Refresh</button>
</div>
<div class="card-body">
<table>
<thead>
<tr>
<th>Name</th>
<th>Email</th>
<th>Role</th>
<th>Status</th>
</tr>
</thead>
<tbody id="employeesBody">
<tr><td colspan="4" style="text-align:center;padding:40px">Loading...</td></tr>
</tbody>
</table>
</div>
</div>

<div class="card" id="clientsTab" style="display:none">
<div class="card-header">
<h5>All Clients</h5>
<button class="btn btn-sm btn-primary" onclick="loadClients()">Refresh</button>
</div>
<div class="card-body">
<table>
<thead>
<tr>
<th>Client Name</th>
<th>Contact</th>
<th>Status</th>
</tr>
</thead>
<tbody id="clientsBody">
<tr><td colspan="3" style="text-align:center;padding:40px">Loading...</td></tr>
</tbody>
</table>
</div>
</div>
</main>

<script src="/assets/auth.js"></script>
<script src="/assets/sidebar.js"></script>
<script src="/assets/bulk-ops.js"></script>
<script>
const show=id=>document.getElementById(id)?.classList.add('show');
const hide=id=>document.getElementById(id)?.classList.remove('show');

const switchTab=t=>{
document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
event.target.classList.add('active');
document.getElementById('employeesTab').style.display=t==='employees'?'block':'none';
document.getElementById('clientsTab').style.display=t==='clients'?'block':'none';
};

let allEmployees=[];
const loadEmployees=async()=>{
try{
show('loading');
const data=await Auth.apiCall('/api/users');
allEmployees=(data.data||[]).filter(u=>u.role==='employee');
const b=document.getElementById('employeesBody');
if(!data.data||!data.data.length){b.innerHTML='<tr><td colspan="4" style="text-align:center;padding:40px">No employees</td></tr>';return}
b.innerHTML=data.data.map(u=>`<tr>
<td><strong>${u.name}</strong></td>
<td>${u.email}</td>
<td><span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;background:${u.role==='admin'?'#fee2e220;color:#ef4444':u.role==='manager'?'#fef3c720;color:#f59e0b':'#d1fae520;color:#10b981'}">${u.role}</span></td>
<td><span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;background:#d1fae520;color:#10b981">Active</span></td>
</tr>`).join('');
}catch(e){
console.error(e);
alert('Failed to load employees');
}finally{hide('loading')}
};

const loadClients=async()=>{
try{
show('loading');
const data=await Auth.apiCall('/api/clients');
const b=document.getElementById('clientsBody');
if(!data.data||!data.data.length){b.innerHTML='<tr><td colspan="3" style="text-align:center;padding:40px">No clients</td></tr>';return}
b.innerHTML=data.data.map(c=>{
const empName=allEmployees.find(e=>e.id===c.assigned_employee_id)?.name||'Unassigned';
return`<tr>
<td><strong>${c.name||'Unknown'}</strong></td>
<td>${c.contact_info?.email||c.contact_email||'N/A'}</td>
<td><select onchange="assignClient('${c.id}',this.value)" style="padding:6px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px"><option value="">Unassigned</option>${allEmployees.map(e=>`<option value="${e.id}" ${c.assigned_employee_id===e.id?'selected':''}>${e.name}</option>`).join('')}</select></td>
</tr>`
}).join('');
}catch(e){
console.error(e);
alert('Failed to load clients');
}finally{hide('loading')}
};

const assignClient=async(clientId,employeeId)=>{
if(!employeeId)return;
try{show('loading');await Auth.apiCall(`/api/clients/${clientId}/assign`,{method:'POST',body:JSON.stringify({employee_id:employeeId})});alert('Client assigned successfully')}catch(e){alert('Failed to assign: '+(e.message||'Unknown error'));await loadClients()}finally{hide('loading')}
};

const showAddEmployee=()=>document.getElementById('addEmployeeModal').style.display='flex';
const hideAddEmployee=()=>{document.getElementById('addEmployeeModal').style.display='none';document.getElementById('empName').value='';document.getElementById('empEmail').value='';document.getElementById('empPassword').value=''};
const showAddClient=()=>document.getElementById('addClientModal').style.display='flex';
const hideAddClient=()=>{document.getElementById('addClientModal').style.display='none';document.getElementById('clientName').value='';document.getElementById('clientCompany').value='';document.getElementById('clientEmail').value='';document.getElementById('clientPhone').value=''};

const submitEmployee=async()=>{
const name=document.getElementById('empName').value.trim(),email=document.getElementById('empEmail').value.trim(),password=document.getElementById('empPassword').value;
if(!name||!email||!password)return alert('Please fill all required fields');
try{show('loading');await Auth.apiCall('/api/employees',{method:'POST',body:JSON.stringify({name,email,password})});alert('Employee added successfully');hideAddEmployee();await loadEmployees()}catch(e){alert('Failed to add employee: '+(e.message||'Unknown error'))}finally{hide('loading')}
};

const submitClient=async()=>{
const name=document.getElementById('clientName').value.trim(),company=document.getElementById('clientCompany').value.trim(),email=document.getElementById('clientEmail').value.trim(),phone=document.getElementById('clientPhone').value.trim();
if(!name)return alert('Please enter client name');
try{show('loading');await Auth.apiCall('/api/clients',{method:'POST',body:JSON.stringify({name,email,phone,company})});alert('Client added successfully');hideAddClient();await loadClients()}catch(e){alert('Failed to add client: '+(e.message||'Unknown error'))}finally{hide('loading')}
};

window.switchTab=switchTab;
window.loadEmployees=loadEmployees;
window.loadClients=loadClients;
window.showAddEmployee=showAddEmployee;
window.hideAddEmployee=hideAddEmployee;
window.showAddClient=showAddClient;
window.hideAddClient=hideAddClient;
window.submitEmployee=submitEmployee;
window.submitClient=submitClient;
window.assignClient=assignClient;

(async()=>{
const user=await Auth.checkAuth('manager');
if(!user)return;
Sidebar.init(user.role||'manager','management');
await loadEmployees();
await loadClients();
})();
</script>
</body>
</html>
