<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Competence CRM</title>
<link rel="stylesheet" href="/assets/sidebar.css">
<link rel="stylesheet" href="/assets/styles.css">
<style>
.content{margin-left:280px;padding:24px;width:calc(100% - 280px);min-height:100vh}
.header{background:#fff;padding:20px 24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:24px}
.header h2{font-size:26px;color:#1e293b;font-weight:700;margin:0 0 4px}
.header p{color:#64748b;font-size:14px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);position:relative}
.stat-card h3{font-size:36px;color:#1e293b;margin:0 0 8px;font-weight:700}
.stat-card p{color:#64748b;font-size:13px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:20px}
.card-header{padding:20px 24px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}
.card-header h5{font-size:18px;color:#1e293b;margin:0;font-weight:700}
.card-body{padding:24px}
.search-box{position:relative;margin-bottom:20px}
.search-box input{width:100%;padding:12px 16px 12px 44px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px}
.search-box i{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#94a3b8}
table{width:100%;border-collapse:collapse;font-size:14px}
thead{background:#f8fafc}
th{padding:14px 16px;text-align:left;font-weight:700;color:#475569;font-size:12px;text-transform:uppercase}
td{padding:14px 16px;border-bottom:1px solid #f1f5f9;color:#334155}
tbody tr:hover{background:#f8fafc}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:#3b82f6;color:#fff}
.btn-primary:hover{background:#2563eb}
.btn-sm{padding:7px 14px;font-size:13px}
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center}
.loading.show{display:flex}
.spinner{border:4px solid rgba(255,255,255,.2);border-top:4px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.content{margin-left:0;width:100%;padding:16px}}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div></div>
<div id="debugPanel" style="position:fixed;top:10px;right:10px;width:400px;max-height:80vh;overflow:auto;background:#000;color:#0f0;padding:10px;font-family:monospace;font-size:11px;z-index:10000;border:2px solid #0f0;display:block"></div>
<div id="sidebarContainer"></div>

<main class="content">
<div class="header">
<h2>Dashboard</h2>
<p>Welcome, <strong id="userName">User</strong></p>
</div>

<div class="stats-grid">
<div class="stat-card">
<h3 id="totalClients">0</h3>
<p>Total Clients</p>
</div>
<div class="stat-card">
<h3 id="goodClients">0</h3>
<p>Good Standing</p>
</div>
<div class="stat-card">
<h3 id="dueSoonClients">0</h3>
<p>Due Soon</p>
</div>
<div class="stat-card">
<h3 id="overdueClients">0</h3>
<p>Overdue</p>
</div>
</div>

<div class="card">
<div class="card-header">
<h5>My Clients</h5>
<button class="btn btn-sm btn-primary" onclick="loadClients()">Refresh</button>
</div>
<div class="card-body">
<div class="search-box">
<i class="fas fa-search"></i>
<input type="text" id="searchInput" placeholder="Search clients..." onkeyup="filterClients()">
</div>
<table>
<thead>
<tr>
<th>Client</th>
<th>Contact</th>
<th>Status</th>
<th>Last Contact</th>
<th>Days</th>
<th>Action</th>
</tr>
</thead>
<tbody id="clientsBody">
<tr><td colspan="6" style="text-align:center;padding:40px">Loading...</td></tr>
</tbody>
</table>
</div>
</div>
</main>

<script src="/assets/auth.js"></script>
<script src="/assets/sidebar.js"></script>
<script>
const show=id=>document.getElementById(id)?.classList.add('show');
const hide=id=>document.getElementById(id)?.classList.remove('show');
const dbg=(msg,data)=>{const p=document.getElementById('debugPanel');if(p){const t=new Date().toLocaleTimeString();p.innerHTML+=`<div>[${t}] ${msg}${data?' '+JSON.stringify(data):''}</div>`;p.scrollTop=p.scrollHeight}};
const days=d=>{if(!d)return 999;const diff=Math.floor((new Date()-new Date(d))/864e5);return diff<0?0:diff};
const formatDate=d=>{if(!d)return'Never';const dt=new Date(d);const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return`${m[dt.getMonth()]} ${dt.getDate()}, ${dt.getFullYear()}`};
const getColorByStatus=s=>s==='good'?'#10b981':s==='due_soon'?'#f59e0b':'#ef4444';
const getLabelByStatus=s=>s==='good'?'Good':s==='due_soon'?'Due Soon':'Overdue';

const render=c=>{
dbg('=== RENDER START ===');
dbg('Clients length:', c?.length);
console.log('=== RENDER START ===');
console.log('CALL STACK:', new Error().stack);
console.log('Clients data:', c);
console.log('Clients length:', c?.length);
const b=document.getElementById('clientsBody');
if(!c?.length){dbg('NO CLIENTS - SETTING ALL TO 0');console.log('NO CLIENTS - SETTING ALL TO 0');b.innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px">No clients assigned</td></tr>';document.getElementById('totalClients').textContent='0';document.getElementById('goodClients').textContent='0';document.getElementById('dueSoonClients').textContent='0';document.getElementById('overdueClients').textContent='0';return}
let o=0,s=0,g=0;
b.innerHTML=c.map(i=>{
const d=(typeof i.days_since_last_contact==='number')?i.days_since_last_contact:days(i.last_contact_date);
dbg(i.name,{lcd:i.last_contact_date,api_days:i.days_since_last_contact,calc:d});
const status=i.status||(d<=7?'good':d<=14?'due_soon':'overdue');
const color=getColorByStatus(status);
const label=getLabelByStatus(status);
status==='overdue'?o++:status==='due_soon'?s++:g++;
return`<tr><td><strong>${i.name||'Unknown'}</strong></td><td>${i.contact_info?.email||i.contact_email||'N/A'}</td><td><span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;background:${color}20;color:${color}">${label}</span></td><td>${formatDate(i.last_contact_date)}</td><td><span style="font-weight:600;color:${color}">${d===999?'âˆž':d===0?'Today':d}</span></td><td><a href="/activity_logging_page/code.html?client=${i.id}" class="btn btn-sm btn-primary">Log</a></td></tr>`
}).join('');
dbg('Stats calc:',{total:c.length,good:g,dueSoon:s,overdue:o});
console.log('Stats calculated:', {total:c.length,good:g,dueSoon:s,overdue:o});
document.getElementById('totalClients').textContent=c.length;
document.getElementById('goodClients').textContent=g;
document.getElementById('dueSoonClients').textContent=s;
document.getElementById('overdueClients').textContent=o;
dbg('Stats set in DOM');
dbg('=== RENDER END ===');
console.log('Stats set in DOM');
console.log('=== RENDER END ===');
};

const load=async()=>{
try{show('loading');dbg('=== LOAD START ===');console.log('=== LOAD START ===');const data=await Auth.apiCall('/api/clients');dbg('API returned:',{count:data.data?.length});console.log('API response:',data);console.log('About to call render with:',data.data);render(data.data||[]);dbg('DOM after render:',{total:document.getElementById('totalClients').textContent,good:document.getElementById('goodClients').textContent,dueSoon:document.getElementById('dueSoonClients').textContent,overdue:document.getElementById('overdueClients').textContent});console.log('Render complete, checking DOM values:');console.log('Total:',document.getElementById('totalClients').textContent);console.log('Good:',document.getElementById('goodClients').textContent);console.log('Due Soon:',document.getElementById('dueSoonClients').textContent);console.log('Overdue:',document.getElementById('overdueClients').textContent)}catch(e){dbg('ERROR:',e.message);console.error('Load error:',e);document.getElementById('clientsBody').innerHTML=`<tr><td colspan="6" style="text-align:center;padding:40px;color:#ef4444">Error: ${e.message}</td></tr>`}finally{hide('loading')}
};
let debounce;
const filter=()=>{clearTimeout(debounce);debounce=setTimeout(()=>{const s=document.getElementById('searchInput').value.toLowerCase();document.querySelectorAll('#clientsBody tr').forEach(r=>r.style.display=r.textContent.toLowerCase().includes(s)?'':'none')},300)};

window.loadClients=load;
window.filterClients=filter;

(async()=>{
dbg('Page init');
const user=await Auth.checkAuth();
if(!user)return;
if(user.role==='manager'||user.role==='admin'){location.href='/manager_dashboard_page/code.html';return}
document.getElementById('userName').textContent=user.name||'User';
Sidebar.init('employee','dashboard');
await load();
dbg('LOAD COMPLETE');
dbg('Final stats:',{total:document.getElementById('totalClients').textContent,good:document.getElementById('goodClients').textContent,dueSoon:document.getElementById('dueSoonClients').textContent,overdue:document.getElementById('overdueClients').textContent});
console.log('INITIAL LOAD COMPLETE - Stats should be visible now');
console.log('Final DOM check:',{total:document.getElementById('totalClients').textContent,good:document.getElementById('goodClients').textContent,dueSoon:document.getElementById('dueSoonClients').textContent,overdue:document.getElementById('overdueClients').textContent});
setInterval(()=>{dbg('AUTO-REFRESH');console.log('AUTO-REFRESH TRIGGERED');load()},3e5)
window.addEventListener('storage',e=>{if(e.key==='crm_last_contact_refresh'){dbg('STORAGE EVENT');console.log('STORAGE EVENT TRIGGERED');load()}})
})();
</script>
</body>
</html>
