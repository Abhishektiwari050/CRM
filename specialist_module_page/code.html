<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Specialist Module - Competence Consulting</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8f9fa;color:#212529}
.wrapper{display:flex;min-height:100vh}
.sidebar{width:260px;background:linear-gradient(180deg,#1e3a8a 0%,#1e40af 100%);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000;box-shadow:2px 0 10px rgba(0,0,0,.1);transition:transform .3s}
.sidebar-header{padding:24px 20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.15)}
.sidebar-header img{width:56px;height:56px;margin:0 auto 12px;border-radius:50%;background:#fff;padding:8px}
.sidebar-header h4{font-size:15px;font-weight:700;margin-bottom:4px}
.sidebar-header .role{font-size:11px;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.5px}
.sidebar-nav{padding:16px 0}
.sidebar-nav a{display:flex;align-items:center;padding:12px 20px;color:rgba(255,255,255,.85);text-decoration:none;transition:all .2s;position:relative;font-size:14px}
.sidebar-nav a:hover{background:rgba(255,255,255,.1);color:#fff}
.sidebar-nav a.active{background:rgba(255,255,255,.15);color:#fff;font-weight:600}
.sidebar-nav a.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#60a5fa}
.sidebar-nav a i{width:20px;margin-right:12px;font-size:16px}
.nav-divider{height:1px;background:rgba(255,255,255,.1);margin:12px 20px}
.content{margin-left:260px;flex:1;padding:24px;width:calc(100% - 260px)}
.header{background:#fff;padding:20px 24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:16px}
.header h2{font-size:26px;color:#1e293b;font-weight:700;margin:0}
.header p{color:#64748b;font-size:14px;margin-top:4px}
.tabs{display:flex;gap:8px;margin-bottom:16px}
.tab{padding:10px 14px;border-radius:8px;background:#e2e8f0;color:#0f172a;cursor:pointer;font-weight:600}
.tab.active{background:#3b82f6;color:#fff}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:16px}
.metric{display:flex;align-items:center;justify-content:space-between}
.metric h3{font-size:14px;color:#334155}
.metric .value{font-size:24px;font-weight:700;color:#0f172a}
.muted{color:#64748b;font-size:12px}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-weight:600;color:#1e293b;margin-bottom:6px;font-size:13px}
.form-group select,.form-group input,.form-group textarea{width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all .2s;font-family:inherit}
.form-group textarea{resize:vertical;min-height:100px}
.btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:#3b82f6;color:#fff}
.btn-primary:hover{background:#2563eb}
.btn-secondary{background:#64748b;color:#fff}
.btn-secondary:hover{background:#475569}
.list{max-height:280px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px}
.list-item{padding:10px 12px;border-bottom:1px solid #e2e8f0}
.list-item:last-child{border-bottom:none}
.list-item h4{font-size:13px;color:#0f172a}
.list-item p{font-size:12px;color:#475569}
.flex{display:flex;gap:12px}
.half{flex:1}
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.loading.show{display:flex}
.spinner{border:4px solid rgba(255,255,255,.2);border-top:4px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.mobile-toggle{display:none;position:fixed;top:16px;left:16px;z-index:1001;background:#3b82f6;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15)}
@media(max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.content{margin-left:0;padding:16px;width:100%}.mobile-toggle{display:block}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div></div>
<button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fas fa-bars"></i></button>

<div class="wrapper">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="/static/images/logo.png" alt="Logo" class="brand-logo">
      <h4>Competence Consulting</h4>
      <div class="role">Specialist Portal</div>
    </div>
    <nav class="sidebar-nav">
      <a href="/employee_dashboard_page/code.html"><i class="fas fa-home"></i>Dashboard</a>
      <a href="/activity_logging_page/code.html"><i class="fas fa-clipboard-check"></i>Log Activity</a>
      <a href="/daily_work_report/code.html"><i class="fas fa-file-alt"></i>Daily Report</a>
      <a href="/notifications_page/code.html"><i class="fas fa-bell"></i>Reminders</a>
      <div class="nav-divider"></div>
      <a href="/specialist_module_page/code.html" class="active"><i class="fas fa-gem"></i>Specialist Module</a>
      <div class="nav-divider"></div>
      <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i>Logout</a>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <h2>Product Posting Specialist</h2>
      <p>Unified workspace: KPIs, Work Log, and Daily Report</p>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab-dashboard" onclick="showTab('dashboard')">Dashboard</div>
      <div class="tab" id="tab-worklog" onclick="showTab('worklog')">Work Log</div>
      <div class="tab" id="tab-dmr" onclick="showTab('dmr')">DMR</div>
    </div>

    <section id="section-dashboard">
      <div class="grid">
        <div class="card">
          <div class="metric"><h3>Today's Posts</h3><div class="value" id="metric-posts">0</div></div>
          <div class="muted">Auto-updates on new postings</div>
        </div>
        <div class="card">
          <div class="metric"><h3>Engagement Rate</h3><div class="value" id="metric-engagement">0%</div></div>
          <div class="muted">From today's DMR metrics</div>
        </div>
        <div class="card">
          <div class="metric"><h3>Clients Contacted</h3><div class="value" id="metric-contacted">0</div></div>
          <div class="muted">Logged interactions today</div>
        </div>
      </div>
      <div class="card">
        <h3 style="color:#334155;font-size:16px;margin-bottom:8px">Daily Posts (last 7 days)</h3>
        <canvas id="postsChart" height="120"></canvas>
      </div>
    </section>

    <section id="section-worklog" style="display:none">
      <div class="flex">
        <div class="card half">
          <h3 style="color:#334155;font-size:16px;margin-bottom:8px">New Activity</h3>
          <form id="activityForm">
            <div class="form-group">
              <label for="client">Client *</label>
              <select id="client" required></select>
            </div>
            <div class="form-group">
              <label for="category">Category *</label>
              <select id="category" required>
                <option value="posting">Posting</option>
                <option value="message">Client Message</option>
                <option value="follow_up">Follow-up</option>
                <option value="meeting">Meeting</option>
              </select>
            </div>
            <div class="form-group">
              <label for="outcome">Outcome *</label>
              <select id="outcome" required>
                <option value="successful">Successful</option>
                <option value="no_response">No Response</option>
                <option value="follow_up">Follow-up Required</option>
                <option value="deal_closed">Deal Closed</option>
              </select>
            </div>
            <div class="form-group">
              <label for="quantity">Quantity</label>
              <input id="quantity" type="number" min="1" value="1" />
            </div>
            <div class="form-group">
              <label for="notes">Notes</label>
              <textarea id="notes" placeholder="Details about this activity..."></textarea>
            </div>
            <div class="form-group">
              <label>Attachments (URLs)</label>
              <div id="attachments"></div>
              <div class="flex"><input type="url" id="attachmentInput" placeholder="https://..." class="half" /><button type="button" class="btn btn-secondary" onclick="addAttachment()"><i class="fas fa-plus"></i>Add</button></div>
              <small class="muted">Paste public links to images/docs</small>
            </div>
            <div class="flex">
              <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>Log Activity</button>
              <button type="button" class="btn btn-secondary" onclick="document.getElementById('activityForm').reset()"><i class="fas fa-undo"></i>Reset</button>
            </div>
          </form>
        </div>
        <div class="card half">
          <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="color:#334155;font-size:16px">Activity History</h3>
            <input type="search" id="search" placeholder="Search notes/outcome" style="max-width:240px" />
          </div>
          <div class="list" id="activityList"></div>
        </div>
      </div>
    </section>

    <section id="section-dmr" style="display:none">
      <div class="grid">
        <div class="card">
          <h3 style="color:#334155;font-size:16px;margin-bottom:8px">Submit Today's DMR</h3>
          <form id="dmrForm">
            <div class="form-group"><label for="posts_completed">Posts Completed *</label><input type="number" id="posts_completed" min="0" required /></div>
            <div class="form-group"><label for="engagements">Engagements</label><input type="number" id="engagements" min="0" /></div>
            <div class="form-group"><label for="observations">Observations</label><textarea id="observations" placeholder="Quality notes, issues, learnings..."></textarea></div>
            <div class="form-group"><label for="tasks">Tasks Summary *</label><textarea id="tasks" required placeholder="Brief summary of today's work"></textarea></div>
            <div class="form-group"><label for="achievements">Achievements</label><textarea id="achievements" placeholder="Highlights"></textarea></div>
            <div class="form-group"><label for="challenges">Challenges</label><textarea id="challenges" placeholder="Blockers"></textarea></div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i>Submit DMR</button>
          </form>
        </div>
        <div class="card">
          <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="color:#334155;font-size:16px">DMR Archive</h3>
            <button class="btn btn-secondary" onclick="refreshDMRs()"><i class="fas fa-rotate"></i>Refresh</button>
          </div>
          <div class="list" id="dmrList"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
// Inline fallbacks for missing dependencies
if(!window.SUPABASE_URL)window.SUPABASE_URL='';if(!window.SUPABASE_ANON_KEY)window.SUPABASE_ANON_KEY='';if(!window.APP_CONFIG)window.APP_CONFIG={brandName:'Competence CRM',environment:'dev'};if(!window.SUPA)window.SUPA={hasKeys:()=>false,subscribe:()=>console.warn('Realtime unavailable')};
const API_BASE = window.location.origin;
const showLoading = () => document.getElementById('loading').classList.add('show');
const hideLoading = () => document.getElementById('loading').classList.remove('show');
function logout(){ localStorage.clear(); sessionStorage.clear(); location.href='../login_page/code.html'; }

function showTab(tab){
  const sections = { dashboard: 'section-dashboard', worklog: 'section-worklog', dmr: 'section-dmr' };
  Object.values(sections).forEach(id => document.getElementById(id).style.display = 'none');
  document.getElementById(sections[tab]).style.display = '';
  ['dashboard','worklog','dmr'].forEach(t => document.getElementById('tab-'+t).classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
}

async function auth(){
  try{
    const u = sessionStorage.getItem('currentUser');
    if (!u){ location.href='../login_page/code.html'; return null; }
    const d = JSON.parse(u);
    if (d.role !== 'employee'){ location.href='../manager_dashboard_page/code.html'; return null; }
    return d;
  }catch(e){ location.href='../login_page/code.html'; return null; }
}

// Dashboard metrics and chart
let postsChart;
function renderPostsChart(labels, values){
  try{
    const ctx = document.getElementById('postsChart');
    if(!ctx)return;
    if (postsChart) postsChart.destroy();
    postsChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Posts', data: values, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: .3 }] },
      options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
  }catch(e){console.error('Chart render failed:',e)}
}

async function initDashboard(user){
  // Load activity counts
  const token = localStorage.getItem('token');
  const today = new Date().toISOString().split('T')[0];
  // Posts today
  let postsToday = 0, contactedToday = 0, engagementRate = 0;
  try{
    const r1 = await fetch(`${API_BASE}/api/activity-feed?category=posting&date_from=${today}`, { headers: { Authorization: `Bearer ${token}` } });
    if (r1.ok){ const j = await r1.json(); postsToday = j.total || 0; }
    const r2 = await fetch(`${API_BASE}/api/activity-feed?date_from=${today}`, { headers: { Authorization: `Bearer ${token}` } });
    if (r2.ok){ const j = await r2.json(); contactedToday = j.total || 0; }
    const r3 = await fetch(`${API_BASE}/api/daily-reports`, { headers: { Authorization: `Bearer ${token}` } });
    if (r3.ok){ const j = await r3.json(); const latest = (j.data||[]).find(x => x.date === today); if (latest && latest.metrics){ const m = latest.metrics; if (m.engagements && m.posts_completed){ engagementRate = Math.round((m.engagements / Math.max(m.posts_completed,1))*100); } }
    }
  }catch(e){ console.warn(e); }
  document.getElementById('metric-posts').textContent = postsToday;
  document.getElementById('metric-contacted').textContent = contactedToday;
  document.getElementById('metric-engagement').textContent = `${engagementRate}%`;

  // Last 7 days posts
  const labels = [], values = [];
  for (let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().split('T')[0]; labels.push(ds.slice(5));
    values.push(0);
  }
  try{
    const r = await fetch(`${API_BASE}/api/activity-feed?category=posting&limit=500`, { headers: { Authorization: `Bearer ${token}` } });
    if (r.ok){ const j = await r.json(); (j.data||[]).forEach(a => {
      const day = (a.created_at||'').slice(0,10);
      const idx = labels.findIndex(l => day.endsWith(l)); if (idx>=0) values[idx] += 1;
    }); }
  }catch(e){ console.warn(e); }
  renderPostsChart(labels, values);

  // Realtime: update metrics/cards
  if (window.SUPA && window.SUPA.hasKeys && window.SUPA.hasKeys()){
    try{
    window.SUPA.subscribe('activity_logs','INSERT', (msg) => {
      const row = msg?.new || {}; const day = (row.created_at||'').slice(0,10);
      const todayStr = new Date().toISOString().slice(0,10);
      if (day === todayStr){
        document.getElementById('metric-contacted').textContent = Number(document.getElementById('metric-contacted').textContent) + 1;
        if (row.category === 'posting'){
          document.getElementById('metric-posts').textContent = Number(document.getElementById('metric-posts').textContent) + 1;
        }
      }
    });
    window.SUPA.subscribe('daily_reports','INSERT', (msg) => {
      const m = (msg?.new||{}).metrics || {}; if (m.engagements && m.posts_completed){
        const rate = Math.round((m.engagements/Math.max(m.posts_completed,1))*100);
        document.getElementById('metric-engagement').textContent = `${rate}%`;
      }
    });
    }catch(e){console.warn('Realtime subscription failed:',e)}
  }else{console.info('Realtime disabled: Supabase keys not configured')}
}

// Work log
function attachmentItem(url){ return `<div class="list-item"><h4>${url}</h4></div>`; }
function addAttachment(){ const inp = document.getElementById('attachmentInput'); const val = (inp.value||'').trim(); if (!val) return; const list = document.getElementById('attachments'); list.insertAdjacentHTML('beforeend', attachmentItem(val)); inp.value=''; }

async function loadClients(){
  try{
    const token = localStorage.getItem('token');
    const r = await fetch(`${API_BASE}/api/clients`, { headers: { Authorization: `Bearer ${token}` } });
    if (!r.ok) throw new Error('Failed to load clients');
    const j = await r.json(); const sel = document.getElementById('client');
    sel.innerHTML = '<option value="">-- Select Client --</option>' + (j.data||[]).map(c => `<option value="${c.id}">${c.name || c.company_name}</option>`).join('');
  }catch(e){ console.warn(e); }
}

async function submitActivity(e){
  e.preventDefault();
  const client = document.getElementById('client').value;
  const category = document.getElementById('category').value;
  const outcome = document.getElementById('outcome').value;
  const quantity = Number(document.getElementById('quantity').value||'1');
  const notes = document.getElementById('notes').value;
  if (!client || !category || !outcome) return alert('Please fill required fields');
  const attachments = Array.from(document.querySelectorAll('#attachments .list-item')).map(x => ({ url: x.querySelector('h4').textContent }));
  try{
    showLoading();
    const token = localStorage.getItem('token');
    const r = await fetch(`${API_BASE}/api/activity-log`, { method:'POST', headers:{ Authorization:`Bearer ${token}`, 'Content-Type':'application/json' }, body: JSON.stringify({ client_id: client, outcome, notes, category, attachments, quantity }) });
    if (!r.ok) throw new Error('Failed');
    await refreshActivities();
    document.getElementById('activityForm').reset(); document.getElementById('attachments').innerHTML='';
  }catch(e){ console.error(e); alert('Failed to log activity'); }
  finally{ hideLoading(); }
}

async function refreshActivities(){
  try{
    const token = localStorage.getItem('token');
    const q = document.getElementById('search').value||'';
    const r = await fetch(`${API_BASE}/api/activity-feed?limit=200&search=${encodeURIComponent(q)}`, { headers:{ Authorization:`Bearer ${token}` } });
    if (!r.ok) throw new Error('Failed');
    const j = await r.json(); const list = document.getElementById('activityList');
    list.innerHTML = (j.data||[]).map(a => `<div class="list-item"><h4>${(a.category||'general')} • ${(a.outcome||'')}</h4><p>${(a.notes||'')}</p><p class="muted">${(a.created_at||'').replace('T',' ').slice(0,19)}</p></div>`).join('');
  }catch(e){ console.error(e); }
}

// DMR
async function submitDMR(e){
  e.preventDefault();
  const posts_completed = Number(document.getElementById('posts_completed').value||'0');
  const engagements = Number(document.getElementById('engagements').value||'0');
  const observations = document.getElementById('observations').value||'';
  const tasks = document.getElementById('tasks').value||'';
  const achievements = document.getElementById('achievements').value||'';
  const challenges = document.getElementById('challenges').value||'';
  if (!posts_completed || !tasks) return alert('Posts Completed and Tasks Summary are required');
  const metrics = { posts_completed, engagements, observations };
  try{
    showLoading();
    const token = localStorage.getItem('token');
    const r = await fetch(`${API_BASE}/api/daily-report`, { method:'POST', headers:{ Authorization:`Bearer ${token}`, 'Content-Type':'application/json' }, body: JSON.stringify({ tasks, achievements, challenges, metrics }) });
    if (!r.ok) throw new Error('Failed');
    await refreshDMRs();
    document.getElementById('dmrForm').reset();
  }catch(e){ console.error(e); alert('Failed to submit DMR'); }
  finally{ hideLoading(); }
}

async function refreshDMRs(){
  try{
    const token = localStorage.getItem('token');
    const r = await fetch(`${API_BASE}/api/daily-reports`, { headers:{ Authorization:`Bearer ${token}` } });
    if (!r.ok) throw new Error('Failed');
    const j = await r.json(); const list = document.getElementById('dmrList');
    list.innerHTML = (j.data||[]).map(d => `<div class="list-item"><h4>${d.date} • v${d.version||1}</h4><p>${(d.tasks||'')}</p><p class="muted">${(d.submitted_at||'').replace('T',' ').slice(0,19)}</p></div>`).join('');
  }catch(e){ console.error(e); }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const user = await auth(); if (!user) return;
  showTab('dashboard');
  await initDashboard(user);
  await loadClients();
  await refreshActivities();
  await refreshDMRs();
  document.getElementById('activityForm').addEventListener('submit', submitActivity);
  document.getElementById('dmrForm').addEventListener('submit', submitDMR);
  document.getElementById('search').addEventListener('input', refreshActivities);
});
</script>
</body>
</html>