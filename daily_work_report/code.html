<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Work Report - Competence CRM</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Styles -->
  <link rel="stylesheet" href="/assets/sidebar.css">
  <link rel="stylesheet" href="/assets/portal.css">
</head>

<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <!-- Main Content -->
  <main class="content">
    <div class="dashboard-header">
      <h1>Daily Work Report</h1>
      <p>Log your daily activities and performance metrics</p>
    </div>

    <div id="alertContainer"></div>

    <div class="main-card">
      <div class="card-header">
        <h2>Today's Work Log</h2>
      </div>
      <div class="card-body">
        <form id="reportForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label for="ta_calls">TA Calls - How Many?</label>
              <input id="ta_calls" type="number" min="0" placeholder="0">
            </div>
            <div class="form-group">
              <label for="ta_calls_to">TA Calls - To Whom?</label>
              <textarea id="ta_calls_to" placeholder="Enter names/companies..." rows="2"></textarea>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label for="renewal_calls">Renewal Calls - How Many?</label>
              <input id="renewal_calls" type="number" min="0" placeholder="0">
            </div>
            <div class="form-group">
              <label for="renewal_calls_to">Renewal Calls - To Whom?</label>
              <textarea id="renewal_calls_to" placeholder="Enter names/companies..." rows="2"></textarea>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label for="service_calls">Service Calls - How Many?</label>
              <input id="service_calls" type="number" min="0" placeholder="0">
            </div>
            <div class="form-group">
              <label for="service_calls_to">Service Calls - To Whom?</label>
              <textarea id="service_calls_to" placeholder="Enter names/companies..." rows="2"></textarea>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label for="zero_star_calls">0 Star Calls</label>
              <input id="zero_star_calls" type="number" min="0" placeholder="0">
            </div>
            <div class="form-group">
              <label for="one_star_calls">1 Star Calls</label>
              <input id="one_star_calls" type="number" min="0" placeholder="0">
            </div>
          </div>

          <div class="form-group">
            <label for="additional_info">Additional Info</label>
            <textarea id="additional_info" placeholder="Any additional information, observations, or notes..."
              rows="3"></textarea>
          </div>

          <button type="submit" class="btn-primary"><i class="fas fa-paper-plane"></i> Submit Report</button>
        </form>
      </div>
    </div>

    <div class="main-card">
      <div class="card-header">
        <h2>My Reports Archive</h2>
        <button class="btn-secondary" onclick="loadArchive()" style="padding: 6px 12px; font-size: 12px;">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div class="card-body">
        <div id="archiveList" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="/assets/auth.js"></script>
  <script src="/assets/sidebar.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      Sidebar.init('employee', 'report');
      initPage();
    });

    const els = {
      loading: document.getElementById('loadingOverlay'),
      alertContainer: document.getElementById('alertContainer'),
      archiveList: document.getElementById('archiveList')
    };

    const showLoading = () => els.loading.classList.add('visible');
    const hideLoading = () => els.loading.classList.remove('visible');

    const showAlert = (msg, type = 'success') => {
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.style.padding = '12px';
      div.style.marginBottom = '16px';
      div.style.borderRadius = '8px';
      div.style.backgroundColor = type === 'success' ? '#dcfce7' : '#fee2e2';
      div.style.color = type === 'success' ? '#166534' : '#991b1b';
      div.textContent = msg;
      els.alertContainer.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    };

    async function initPage() {
      const user = await Auth.checkAuth('employee');
      if (!user) return;

      document.getElementById('reportForm').addEventListener('submit', submitReport);
      await loadDraft();
      await loadArchive();

      // Auto-save draft
      setInterval(autoSave, 30000);
    }

    function collectData() {
      return {
        ta_calls: Number(document.getElementById('ta_calls').value) || null,
        ta_calls_to: document.getElementById('ta_calls_to').value || null,
        renewal_calls: Number(document.getElementById('renewal_calls').value) || null,
        renewal_calls_to: document.getElementById('renewal_calls_to').value || null,
        service_calls: Number(document.getElementById('service_calls').value) || null,
        service_calls_to: document.getElementById('service_calls_to').value || null,
        zero_star_calls: Number(document.getElementById('zero_star_calls').value) || null,
        one_star_calls: Number(document.getElementById('one_star_calls').value) || null,
        additional_info: document.getElementById('additional_info').value || null
      };
    }

    async function submitReport(e) {
      e.preventDefault();
      const data = collectData();

      try {
        showLoading();
        await Auth.apiCall('/api/daily-report', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        showAlert('Daily work report submitted successfully!');
        document.getElementById('reportForm').reset();
        localStorage.removeItem('dmr_draft'); // Clear draft
        await loadArchive();
      } catch (e) {
        console.error(e);
        showAlert(e.message || 'Failed to submit report', 'danger');
      } finally {
        hideLoading();
      }
    }

    async function loadArchive() {
      try {
        const res = await Auth.apiCall('/api/daily-reports');
        const reports = res.data || [];

        if (reports.length === 0) {
          els.archiveList.innerHTML = '<p style="text-align:center; color:var(--text-muted)">No reports submitted yet.</p>';
          return;
        }

        els.archiveList.innerHTML = reports.map(d => {
          const m = d.metrics || {};
          let content = '';
          if (m.ta_calls) content += `<div><strong>TA Calls:</strong> ${m.ta_calls} ${m.ta_calls_to ? `→ ${m.ta_calls_to}` : ''}</div>`;
          if (m.renewal_calls) content += `<div><strong>Renewal:</strong> ${m.renewal_calls} ${m.renewal_calls_to ? `→ ${m.renewal_calls_to}` : ''}</div>`;
          if (m.service_calls) content += `<div><strong>Service:</strong> ${m.service_calls} ${m.service_calls_to ? `→ ${m.service_calls_to}` : ''}</div>`;
          if (m.zero_star_calls) content += `<div><strong>0★:</strong> ${m.zero_star_calls}</div>`;
          if (m.one_star_calls) content += `<div><strong>1★:</strong> ${m.one_star_calls}</div>`;
          if (m.additional_info) content += `<div style="margin-top:4px; font-style:italic; color:var(--text-muted)">${m.additional_info}</div>`;

          return `
                        <div style="padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: #f9fafb;">
                            <div style="font-size:12px; font-weight:700; color:var(--primary); margin-bottom:8px;">
                                <i class="fas fa-calendar"></i> ${d.date || 'N/A'} 
                                <span style="color:var(--text-muted); font-weight:400; margin-left:8px;">Submitted: ${new Date(d.submitted_at).toLocaleString()}</span>
                            </div>
                            <div style="font-size:13px; color:var(--text-main); line-height:1.5;">${content || 'No data'}</div>
                        </div>
                    `;
        }).join('');

      } catch (e) {
        console.error(e);
        els.archiveList.innerHTML = '<p style="text-align:center; color:var(--text-muted)">Failed to load reports.</p>';
      }
    }

    async function loadDraft() {
      try {
        // Try local first
        const local = localStorage.getItem('dmr_draft');
        if (local) {
          fillForm(JSON.parse(local));
          return;
        }
        // Try server
        const res = await Auth.apiCall('/api/daily-report/draft');
        if (res.data && res.data.metrics) {
          fillForm(res.data.metrics);
        }
      } catch (e) { /* Ignore draft load errors */ }
    }

    function fillForm(data) {
      for (const [key, val] of Object.entries(data)) {
        const el = document.getElementById(key);
        if (el && val !== null) el.value = val;
      }
    }

    async function autoSave() {
      const data = collectData();
      localStorage.setItem('dmr_draft', JSON.stringify(data));
      try {
        await Auth.apiCall('/api/daily-report/draft', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      } catch (e) { /* Ignore auto-save errors */ }
    }
  </script>
</body>

</html>