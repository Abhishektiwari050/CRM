<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manager Dashboard - Competence CRM</title>
<link rel="stylesheet" href="/assets/sidebar.css">
<link rel="stylesheet" href="/assets/styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.content{margin-left:280px;padding:24px;width:calc(100% - 280px);min-height:100vh}
.header{background:#fff;padding:20px 24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:24px}
.header h2{font-size:26px;color:#1e293b;font-weight:700;margin:0 0 4px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.stat-card h3{font-size:36px;color:#1e293b;margin:0 0 8px;font-weight:700}
.stat-card p{color:#64748b;font-size:13px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:20px}
.card-header{padding:20px 24px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}
.card-header h5{font-size:18px;color:#1e293b;margin:0;font-weight:700}
.card-body{padding:24px}
.chart-container{position:relative;height:300px}
table{width:100%;border-collapse:collapse;font-size:14px}
thead{background:#f8fafc}
th{padding:14px 16px;text-align:left;font-weight:700;color:#475569;font-size:12px;text-transform:uppercase}
td{padding:14px 16px;border-bottom:1px solid #f1f5f9;color:#334155}
tbody tr:hover{background:#f8fafc}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:#6366f1;color:#fff}
.btn-primary:hover{background:#4f46e5}
.btn-sm{padding:7px 14px;font-size:13px}
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center}
.loading.show{display:flex}
.spinner{border:4px solid rgba(255,255,255,.2);border-top:4px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.perf-bar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-top:8px}
.perf-fill{height:100%;background:linear-gradient(90deg,#10b981,#34d399);transition:width .3s}
@media(max-width:768px){.content{margin-left:0;width:100%;padding:16px}}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div></div>
<div id="sidebarContainer"></div>

<main class="content">
<div class="header">
<h2>Manager Dashboard</h2>
<p>Welcome, <strong id="userName">Manager</strong></p>
</div>

<div class="stats-grid">
<div class="stat-card">
<h3 id="totalEmployees">0</h3>
<p>Active Employees</p>
</div>
<div class="stat-card">
<h3 id="totalClients">0</h3>
<p>Total Clients</p>
</div>
<div class="stat-card">
<h3 id="overdueClients">0</h3>
<p>Overdue Clients</p>
</div>
<div class="stat-card">
<h3 id="efficiency">0%</h3>
<p>Team Efficiency</p>
</div>
</div>

<div class="card">
<div class="card-header">
<h5>Performance Analytics</h5>
</div>
<div class="card-body">
<div class="chart-container">
<canvas id="performanceChart"></canvas>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h5>Employee Performance</h5>
<button class="btn btn-sm btn-primary" onclick="loadPerformance()">Refresh</button>
</div>
<div class="card-body">
<table>
<thead>
<tr>
<th>Employee</th>
<th>Assigned</th>
<th>Overdue</th>
<th>Activities (7d)</th>
<th>Efficiency</th>
<th>Performance</th>
</tr>
</thead>
<tbody id="performanceBody">
<tr><td colspan="6" style="text-align:center;padding:40px">Loading...</td></tr>
</tbody>
</table>
</div>
</div>
</main>

<script src="/assets/auth.js"></script>
<script src="/assets/sidebar.js"></script>
<script>
const show=id=>document.getElementById(id)?.classList.add('show');
const hide=id=>document.getElementById(id)?.classList.remove('show');
let perfChart;

const updateChart=d=>{if(perfChart)perfChart.destroy();perfChart=new Chart(document.getElementById('performanceChart').getContext('2d'),{type:'bar',data:{labels:d.map(e=>e.name),datasets:[{label:'Efficiency %',data:d.map(e=>e.efficiency||0),backgroundColor:'rgba(99,102,241,0.5)',borderColor:'rgba(99,102,241,1)',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}})};

const renderPerf=d=>{
const b=document.getElementById('performanceBody');
if(!d?.length){b.innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px">No employees</td></tr>';return}
b.innerHTML=d.map(e=>{const eff=e.efficiency||0,color=eff>=90?'#10b981':eff>=75?'#f59e0b':'#ef4444';return`<tr><td><strong>${e.name}</strong></td><td>${e.assigned_clients||0}</td><td><span style="color:#ef4444;font-weight:600">${e.overdue_clients||0}</span></td><td>${e.activities_this_week||0}</td><td><span style="padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;background:${color}20;color:${color}">${eff}%</span></td><td><div class="perf-bar"><div class="perf-fill" style="width:${eff}%;background:linear-gradient(90deg,${color},${color})"></div></div></td></tr>`}).join('');
updateChart(d)
};

const loadStats=async()=>{try{const data=await Auth.apiCall('/api/manager/stats');document.getElementById('totalEmployees').textContent=data.employees||0;document.getElementById('totalClients').textContent=data.clients||0;document.getElementById('overdueClients').textContent=data.overdue||0;document.getElementById('efficiency').textContent=(data.efficiency||0)+'%'}catch(e){console.error(e)}};
const loadPerformance=async()=>{try{show('loading');const data=await Auth.apiCall('/api/manager/employee-performance');renderPerf(data.data||[])}catch(e){console.error(e);document.getElementById('performanceBody').innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px;color:#ef4444">Error loading data</td></tr>'}finally{hide('loading')}};
const loadData=async()=>await Promise.all([loadStats(),loadPerformance()]);

window.loadPerformance=loadPerformance;

(async()=>{
const user=await Auth.checkAuth('manager');
if(!user)return;
document.getElementById('userName').textContent=user.name||'Manager';
Sidebar.init(user.role||'manager','dashboard');
await loadData();
setInterval(loadData,3e5)
window.addEventListener('storage',e=>{if(e.key==='crm_last_contact_refresh'){loadData()}})
})();
</script>
</body>
</html>
