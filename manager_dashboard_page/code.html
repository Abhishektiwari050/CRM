<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Competence Consulting E-commerce LLP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/assets/api.js"></script>
    <script src="/assets/ui.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529
        }

        .wrapper {
            display: flex;
            min-height: 100vh
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0, 0, 0, .15);
            transition: transform .3s;
            border-right: 1px solid #8b5cf6
        }

        .sidebar-header {
            padding: 28px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(99, 102, 241, 0.9);
            backdrop-filter: blur(10px)
        }

        .sidebar-header .logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2)
        }

        .sidebar-header .logo img {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            object-fit: cover
        }

        .sidebar-header h4 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
            line-height: 1.3;
            color: #ffffff;
            letter-spacing: 0.5px
        }

        .sidebar-header .role {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block
        }

        .sidebar-nav {
            padding: 16px 0
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all .3s ease;
            position: relative;
            font-size: 14px;
            font-weight: 500;
            margin: 4px 12px;
            border-radius: 10px
        }

        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1)
        }

        .sidebar-nav a.active {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2)
        }

        .sidebar-nav a.active::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: #ffffff;
            border-radius: 2px
        }

        .sidebar-nav a i {
            width: 20px;
            margin-right: 12px;
            font-size: 16px
        }

        .nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 16px 20px
        }

        .content {
            margin-left: 260px;
            flex: 1;
            padding: 24px;
            width: calc(100% - 260px)
        }

        .header {
            background: #fff;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px
        }

        .header h2 {
            font-size: 26px;
            color: #1e293b;
            font-weight: 700;
            margin: 0
        }

        .header .user-info {
            color: #64748b;
            font-size: 14px;
            margin-top: 4px
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px
        }

        .stat-card {
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            position: relative;
            overflow: hidden;
            transition: transform .2s, box-shadow .2s
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .12)
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent)
        }

        .stat-card.primary {
            --accent: #6366f1
        }

        .stat-card.success {
            --accent: #10b981
        }

        .stat-card.warning {
            --accent: #f59e0b
        }

        .stat-card.danger {
            --accent: #ef4444
        }

        .stat-card h3 {
            font-size: 36px;
            color: #1e293b;
            margin-bottom: 8px;
            font-weight: 700
        }

        .stat-card p {
            color: #64748b;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: .5px;
            font-weight: 600
        }

        .stat-card i {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 32px;
            color: var(--accent);
            opacity: .15
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
            margin-bottom: 20px;
            overflow: hidden
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc
        }

        .card-header h5 {
            font-size: 18px;
            color: #1e293b;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .card-body {
            padding: 24px
        }

        .chart-container {
            position: relative;
            height: 300px
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #f1f5f9
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px
        }

        thead {
            background: #f8fafc
        }

        th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 700;
            color: #475569;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .5px;
            white-space: nowrap
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155
        }

        tbody tr {
            transition: background .15s
        }

        tbody tr:hover {
            background: #f8fafc
        }

        tbody tr:last-child td {
            border-bottom: 0
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap
        }

        .badge i {
            font-size: 8px
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all .2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap
        }

        .btn-primary {
            background: #6366f1;
            color: #fff
        }

        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, .3)
        }

        .btn-success {
            background: #10b981;
            color: #fff
        }

        .btn-success:hover {
            background: #059669
        }

        .btn-sm {
            padding: 7px 14px;
            font-size: 13px
        }

        .loading {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px)
        }

        .loading.show {
            display: flex
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, .2);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin .8s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8
        }

        .empty-state i {
            font-size: 56px;
            margin-bottom: 16px;
            opacity: .4
        }

        .alert {
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            animation: slideIn .3s
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: #6366f1;
            color: #fff;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .15)
        }

        .perf-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px
        }

        .perf-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width .3s
        }

        .perf-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24)
        }

        .perf-fill.danger {
            background: linear-gradient(90deg, #ef4444, #f87171)
        }

        @media(max-width:768px) {
            .sidebar {
                transform: translateX(-100%)
            }

            .sidebar.open {
                transform: translateX(0)
            }

            .content {
                margin-left: 0;
                padding: 16px;
                width: 100%
            }

            .mobile-toggle {
                display: block
            }

            .header {
                padding: 16px
            }

            .header h2 {
                font-size: 22px
            }

            .stats-grid {
                grid-template-columns: 1fr
            }

            .stat-card h3 {
                font-size: 28px
            }

            table {
                font-size: 12px
            }

            th,
            td {
                padding: 10px 8px
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px
            }
        }
    </style>
</head>

<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i
            class="fas fa-bars"></i></button>

    <div class="wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><img src="/static/images/logo.png" alt="CRM Logo"></div>
                <h4 class="brand-name">Competence CRM</h4>
                <div class="role">Manager Portal</div>
            </div>
            <nav class="sidebar-nav">
                <a href="/manager_dashboard_page/code.html" class="active"><i
                        class="fas fa-chart-line"></i>Dashboard</a>
                <a href="/management_page/code.html"><i class="fas fa-users"></i>All Clients</a>
                <a href="/notifications_page/code.html"><i class="fas fa-bell"></i>Notifications</a>
                <a href="/management_page/code.html"><i class="fas fa-user-cog"></i>Team Management</a>
                <a href="/reports_page/code.html"><i class="fas fa-file-alt"></i>Reports</a>
                <div class="nav-divider"></div>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i>Logout</a>
            </nav>
        </aside>

        <main class="content">
            <div class="header">
                <div>
                    <h2>Manager Dashboard</h2>
                    <div class="user-info">Welcome, <strong id="userName">Manager</strong></div>
                </div>
                <button class="btn btn-success" onclick="loadData()"><i class="fas fa-sync-alt"></i>Refresh</button>
            </div>

            <div id="alertContainer"></div>

            <div class="stats-grid">
                <div class="stat-card primary"><i class="fas fa-users"></i>
                    <h3 id="totalEmployees">0</h3>
                    <p>Active Employees</p>
                </div>
                <div class="stat-card success"><i class="fas fa-briefcase"></i>
                    <h3 id="totalClients">0</h3>
                    <p>Total Clients</p>
                </div>
                <div class="stat-card warning"><i class="fas fa-exclamation-circle"></i>
                    <h3 id="overdueClients">0</h3>
                    <p>Overdue Clients</p>
                </div>
                <div class="stat-card danger"><i class="fas fa-chart-pie"></i>
                    <h3 id="efficiency">0%</h3>
                    <p>Team Efficiency</p>
                </div>
            </div>



            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-tie"></i>Employee Performance</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadPerformance()"><i
                            class="fas fa-sync"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Assigned</th>
                                    <th>Overdue</th>
                                    <th>Activities (7d)</th>
                                    <th>Efficiency</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody id="performanceBody">
                                <tr>
                                    <td colspan="6" class="empty-state"><i class="fas fa-spinner fa-spin"></i>
                                        <p>Loading...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i>Recent Activities</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadRecentActivities()"><i
                            class="fas fa-sync"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div id="recentActivities"
                        style="max-height:280px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file-alt"></i>Reports Archive</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadReportsArchive()"><i
                            class="fas fa-sync"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div id="reportsArchive"
                        style="max-height:280px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-traffic-light"></i>Alerts</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadAlerts()"><i
                            class="fas fa-sync"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div id="alertsList" class="empty-state"><i class="fas fa-bell"></i>
                        <p>No alerts</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-flag"></i>DMR Flags (Duplicates)</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadReportFlags()"><i
                            class="fas fa-sync"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div id="reportFlags" class="empty-state"><i class="fas fa-flag"></i>
                        <p>No flags</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-balance-scale"></i>Workload Distribution</h5>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-sm btn-primary" onclick="loadWorkload()"><i
                                class="fas fa-sync"></i>Refresh</button>
                        <button class="btn btn-sm btn-success" onclick="exportData('clients')"><i
                                class="fas fa-file-csv"></i>Clients CSV</button>
                        <button class="btn btn-sm btn-success" onclick="exportData('reports')"><i
                                class="fas fa-file-csv"></i>Reports CSV</button>
                        <button class="btn btn-sm btn-success" onclick="exportData('activities')"><i
                                class="fas fa-file-csv"></i>Activities CSV</button>
                        <button class="btn btn-sm btn-success" onclick="exportData('all')"><i
                                class="fas fa-download"></i>Export All</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Assigned Clients</th>
                                    <th>Postings Today</th>
                                </tr>
                            </thead>
                            <tbody id="workloadBody">
                                <tr>
                                    <td colspan="3" class="empty-state"><i class="fas fa-spinner fa-spin"></i>
                                        <p>Loading...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="patternsAlert" style="display:none"></div>
        </main>
    </div>

    <script>
        function show(id) { const el = document.getElementById(id); if (el) el.style.display = 'flex'; }
        function hide(id) { const el = document.getElementById(id); if (el) el.style.display = 'none'; }
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            const alertEl = document.createElement('div');
            alertEl.className = `alert alert-${type}`;
            const icon = type === 'danger' ? 'times' : 'check';
            alertEl.innerHTML = `<i class="fas fa-${icon}-circle"></i> ${message}`;
            container.appendChild(alertEl);
            setTimeout(() => alertEl.remove(), 5000);
        }

        const ManagerDashboard = {
            user: null,
            performanceChart: null,
            init() {
                document.addEventListener('DOMContentLoaded', async () => {
                    hide('loading');
                    this.user = await this.authenticate();
                    if (this.user) this.loadAllData();
                });
            },
            async authenticate() {
                try {
                    const userStr = sessionStorage.getItem('currentUser');
                    if (!userStr) { this.redirectToLogin(); return null; }
                    const userData = JSON.parse(userStr);
                    if (userData.role !== 'manager' && userData.role !== 'admin') { location.href = '/employee_dashboard_page/code.html'; return null; }
                    document.getElementById('userName').textContent = userData.name || 'Manager';
                    return userData;
                } catch (e) { this.redirectToLogin(); return null; }
            },
            async loadAllData() {
                show('loading');
                await Promise.all([
                    this.loadStats(),

                    this.loadPerformance(),
                    this.loadAlerts(),
                    this.loadWorkload(),
                    this.loadRecentActivities(),
                    this.loadReportsArchive(),
                    this.loadReportFlags()
                ]);
                hide('loading');
            },
            renderStats(data) {
                document.getElementById('totalEmployees').textContent = data.employees || 0;
                document.getElementById('totalClients').textContent = data.clients || 0;
                document.getElementById('overdueClients').textContent = data.overdue || 0;
                document.getElementById('efficiency').textContent = (data.efficiency || 0) + '%';
            },
            async loadStats() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/manager/stats', { headers: { Authorization: `Bearer ${token}` } });
                    if (res.ok) { const data = await res.json(); this.renderStats(data); }
                } catch (e) { console.error('Stats error:', e); }
            },

            async loadPerformance() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/manager/employee-performance', { headers: { Authorization: `Bearer ${token}` } });
                    if (res.ok) { const data = await res.json(); this.renderPerformance(data.data || []); }
                } catch (e) { console.error('Performance error:', e); }
            },
            renderPerformance(employees) {
                const tbody = document.getElementById('performanceBody');
                if (!employees || !employees.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-users"></i><p>No employee data found</p></td></tr>'; return; }
                const sorted = employees.sort((a, b) => { if (b.overdue_clients !== a.overdue_clients) return b.overdue_clients - a.overdue_clients; return a.efficiency - b.efficiency; });
                tbody.innerHTML = sorted.map(e => `<tr>
                    <td><div style="font-weight:600;color:#0f172a">${e.name}</div><div style="font-size:12px;color:#64748b">${e.email}</div></td>
                    <td><div style="font-size:14px;font-weight:600">${e.assigned_clients}</div><div style="font-size:11px;color:#64748b">Total Clients</div></td>
                    <td><div style="font-size:14px;font-weight:600;color:${e.overdue_clients > 0 ? '#ef4444' : '#10b981'}">${e.overdue_clients}</div><div style="font-size:11px;color:#64748b">Overdue</div></td>
                    <td><div style="font-size:14px;font-weight:600">${e.activities_this_week}</div><div style="font-size:11px;color:#64748b">Activities</div></td>
                    <td><div class="progress-bar"><div class="progress-fill ${e.efficiency >= 80 ? 'high' : e.efficiency >= 50 ? 'medium' : 'low'}" style="width:${e.efficiency}%"></div></div><div style="font-size:11px;text-align:right;margin-top:4px">${e.efficiency}%</div></td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteUser('${e.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
            },
            async loadAlerts() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/manager/alerts', { headers: { Authorization: `Bearer ${token}` } });
                    const alertsList = document.getElementById('alertsList');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.data && data.data.length) {
                            alertsList.innerHTML = data.data.map(a => `<div class="alert-item ${a.type}"><i class="fas fa-${a.type === 'critical' ? 'exclamation-circle' : 'info-circle'}"></i><div><div style="font-weight:500">${a.title}</div><div style="font-size:12px;opacity:0.9">${a.message}</div></div></div>`).join('');
                        } else { alertsList.innerHTML = '<div class="empty-state"><i class="fas fa-bell"></i><p>No alerts</p></div>'; }
                    }
                } catch (e) { console.error('Alerts error:', e); }
            },
            async loadReportFlags() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/manager/report-flags', { headers: { Authorization: `Bearer ${token}` } });
                    const container = document.getElementById('reportFlags');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.data && data.data.length) {
                            container.innerHTML = '';
                            data.data.forEach(f => { const p = document.createElement('p'); p.textContent = `${f.name} repeated ${f.count} times`; container.appendChild(p); });
                        } else { container.innerHTML = '<div class="empty-state"><i class="fas fa-flag"></i><p>No flags</p></div>'; }
                    }
                } catch (e) { console.error('Report flags error:', e); }
            },
            async loadWorkload() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/manager/workload-distribution', { headers: { Authorization: `Bearer ${token}` } });
                    const tbody = document.getElementById('workloadBody');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.data && data.data.length) {
                            tbody.innerHTML = '';
                            data.data.forEach(item => { const row = tbody.insertRow(); row.insertCell().textContent = item.name; row.insertCell().textContent = item.assigned_clients; row.insertCell().textContent = item.postings_today; });
                        } else { tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><i class="fas fa-inbox"></i><p>No workload data</p></td></tr>'; }
                    }
                } catch (e) { console.error('Workload error:', e); }
            },
            async loadRecentActivities() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/activity-feed?limit=50', { headers: { Authorization: `Bearer ${token}` } });
                    const container = document.getElementById('recentActivities');
                    if (res.ok) {
                        const data = await res.json();
                        const list = (data.data || []).map(a => {
                            let method = ''; let due = '';
                            try { const meta = (a.attachments || []).find(x => x.type === 'contact_meta'); if (meta) { method = meta.method || ''; due = meta.due_date || '' } } catch { }
                            return `<div style="padding:10px;border-bottom:1px solid #e2e8f0"><div style="font-size:12px;color:#0f172a">${(a.category || 'service')} • ${(a.outcome || '')}${method ? ` • ${method}` : ''}</div><div style="font-size:12px;color:#475569">${(a.notes || '')}</div><div style="font-size:11px;color:#64748b">${(a.created_at || '').replace('T', ' ').slice(0, 19)}${due ? ` • Follow-up: ${String(due).replace('T', ' ').slice(0, 16)}` : ''}</div></div>`
                        }).join('');
                        container.innerHTML = list || '<div class="empty-state"><i class="fas fa-inbox"></i><p>No recent activities</p></div>';
                    }
                } catch (e) { console.error('Activities error:', e); }
            },
            async loadReportsArchive() {
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/daily-reports', { headers: { Authorization: `Bearer ${token}` } });
                    const container = document.getElementById('reportsArchive');
                    if (res.ok) {
                        const data = await res.json();
                        const html = (data.data || []).map(d => {
                            const m = d.metrics || {}; let content = '';
                            if (m.ta_calls) { content += `<strong>TA:</strong> ${m.ta_calls}`; if (m.ta_calls_to) content += ` → ${m.ta_calls_to}`; content += '<br>'; }
                            if (m.renewal_calls) { content += `<strong>Renewal:</strong> ${m.renewal_calls}`; if (m.renewal_calls_to) content += ` → ${m.renewal_calls_to}`; content += '<br>'; }
                            if (m.service_calls) { content += `<strong>Service:</strong> ${m.service_calls}`; if (m.service_calls_to) content += ` → ${m.service_calls_to}`; content += '<br>'; }
                            if (m.zero_star_calls) content += `<strong>0★:</strong> ${m.zero_star_calls}<br>`;
                            if (m.one_star_calls) content += `<strong>1★:</strong> ${m.one_star_calls}<br>`;
                            if (m.additional_info) content += `<em>${m.additional_info}</em>`;
                            return `<div style="padding:10px;border-bottom:1px solid #e2e8f0"><div style="font-size:12px;color:#0f172a">${d.employee_name || 'Employee'} • ${d.date || ''}</div><div style="font-size:12px;color:#475569">${content || 'No data'}</div><div style="font-size:11px;color:#64748b">${(d.submitted_at || '').replace('T', ' ').slice(0, 19)}</div></div>`
                        }).join('');
                        container.innerHTML = html || '<div class="empty-state"><i class="fas fa-inbox"></i><p>No reports</p></div>';
                    }
                } catch (e) { console.error('Reports error:', e); }
            },
            logout() { localStorage.clear(); sessionStorage.clear(); this.redirectToLogin(); },
            redirectToLogin() { location.href = '../login_page/code.html'; },
            async deleteUser(id) {
                if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch(`/api/admin/users/${id}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    if (res.ok) {
                        showAlert('User deleted successfully', 'success');
                        this.loadPerformance();
                        this.loadStats();
                    } else {
                        const err = await res.json();
                        showAlert(err.detail || 'Failed to delete user', 'danger');
                    }
                } catch (e) {
                    console.error('Delete user error:', e);
                    showAlert('Failed to delete user', 'danger');
                }
            }
        };

        window.logout = () => ManagerDashboard.logout();
        window.loadData = () => ManagerDashboard.loadAllData();
        window.loadPerformance = () => ManagerDashboard.loadPerformance();
        window.loadAlerts = () => ManagerDashboard.loadAlerts();
        window.loadWorkload = () => ManagerDashboard.loadWorkload();
        window.loadRecentActivities = () => ManagerDashboard.loadRecentActivities();
        window.loadReportsArchive = () => ManagerDashboard.loadReportsArchive();
        window.loadReportFlags = () => ManagerDashboard.loadReportFlags();
        window.deleteUser = (id) => ManagerDashboard.deleteUser(id);

        window.exportData = async (type) => {
            const token = localStorage.getItem('token');
            if (!token) return;
            show('loading');
            try {
                if (type === 'all') { await Promise.all([exportSingle('clients', token), exportSingle('reports', token), exportSingle('activities', token)]); showAlert('All data exported successfully!', 'success'); }
                else { await exportSingle(type, token); showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} exported successfully!`, 'success'); }
            } catch (e) { showAlert('Export failed: ' + e.message, 'danger'); } finally { hide('loading'); }
        };

        async function exportSingle(type, token) {
            let endpoint, filename;
            if (type === 'clients') { endpoint = '/api/export/clients'; filename = `clients_${new Date().toISOString().split('T')[0]}.csv`; }
            else if (type === 'reports') { endpoint = '/api/export/daily-reports'; filename = `daily_reports_${new Date().toISOString().split('T')[0]}.csv`; }
            else if (type === 'activities') { endpoint = '/api/export/activities'; filename = `activities_${new Date().toISOString().split('T')[0]}.csv`; }
            const res = await fetch(`${window.location.origin}${endpoint}`, { headers: { Authorization: `Bearer ${token}` } });
            if (!res.ok) throw new Error('Export failed');
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click();
            window.URL.revokeObjectURL(url); document.body.removeChild(a);
        }

        ManagerDashboard.init();
        window.addEventListener('storage', (e) => { if (e.key === 'crm_last_contact_refresh') ManagerDashboard.loadAllData(); });
    </script>

</body>

</html>